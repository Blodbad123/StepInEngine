<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>7.5 Addendum</title><link rel="stylesheet" href="core.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.74.0"/></head><body><div class="sect1" title="7.5 Addendum"><div class="titlepage"><div><div><h1 class="title"><a id="addendum-id5"/>7.5 Addendum</h1></div></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>Thursday, November 15, 2007</em></span></p></div><p>Since the vulnerability has been fixed and a new version of the XNU kernel of OS X is available, I released a detailed security advisory on my website today.<sup>[<a href="ch07s05.html#ftn.CHP-7-FN-6" class="footnoteref">80</a>]</sup> The bug was assigned CVE-2007-4686.<a id="IDX-CHP-7-0025" class="indexterm"/></p><p>After I published the advisory, Theo de Raadt (the founder of OpenBSD and OpenSSH) hinted that this bug is older than 4.4BSD and was fixed roughly 15 years ago by everyone but Apple. In the initial revision of FreeBSD from 1994, the implementation of the <code class="literal">TIOCSETD</code> IOCTL looks like this:<sup>[<a href="ch07s05.html#ftn.CHP-7-FN-7" class="footnoteref">81</a>]</sup><a id="IDX-CHP-7-0026" class="indexterm"/><a id="IDX-CHP-7-0027" class="indexterm"/></p><a id="I_programlisting7_d1e8648"/><pre class="programlisting">[..]
804       case TIOCSETD: {        /* set line discipline */
805           register int t = *(int *)data;
806           dev_t device = tp-&gt;t_dev;
807
<strong class="userinput"><code>808           if ((u_int)t &gt;= nlinesw)</code></strong>
<strong class="userinput"><code>809               return (ENXIO);</code></strong>
810           if (t != tp-&gt;t_line) {
811               s = spltty();
812               (*linesw[tp-&gt;t_line].l_close)(tp, flag);
813               error = (*linesw[t].l_open)(device, tp);
814               if (error) {
815                   (void)(*linesw[tp-&gt;t_line].l_open)(device, tp);
816                   splx(s);
817                   return (error);
818               }
819               tp-&gt;t_line = t;
820               splx(s);
821           }
822           break;
823       }
[..]</pre><p>Since <code class="literal">t</code> gets cast into an unsigned int in line 808, it can never become negative. If the user-derived data is greater than <code class="literal">0x80000000</code>, the function returns with an error (see line 809). So Theo was right—the bug was indeed already fixed in 1994. <a class="xref" href="ch07s05.html#timeline_from_the_time_i_notified_apple" title="Figure 7-4. Timeline from the time I notified Apple until I released a security advisory">Figure 7-4</a> shows the timeline of the bug’s fix.</p><div class="figure"><a id="timeline_from_the_time_i_notified_apple"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject7_d1e8669"/><img src="httpatomoreillycomsourcenostarchimages939329.png.jpg" alt="Timeline from the time I notified Apple until I released a security advisory"/></div></div><p class="title">Figure 7-4. Timeline from the time I notified Apple until I released a security advisory</p></div><div class="sect2" title="Notes"><div class="titlepage"><div><div><h2 class="title"><a id="notes-id6"/>Notes</h2></div></div></div><p><sup>[<a id="CHP-7-FN-1" href="#ftn.CHP-7-FN-1" class="footnote">75</a>]</sup><a id="IDX-CHP-7-0028" class="indexterm"/></p><p><sup>[<a id="CHP-7-FN-2" href="#ftn.CHP-7-FN-2" class="footnote">76</a>]</sup></p><p><sup>[<a id="CHP-7-FN-3" href="#ftn.CHP-7-FN-3" class="footnote">77</a>]</sup></p><p><sup>[<a id="CHP-7-FN-4" href="#ftn.CHP-7-FN-4" class="footnote">78</a>]</sup></p><p><sup>[<a id="CHP-7-FN-5" href="#ftn.CHP-7-FN-5" class="footnote">79</a>]</sup></p><p><sup>[<a id="CHP-7-FN-6" href="#ftn.CHP-7-FN-6" class="footnote">80</a>]</sup><a id="IDX-CHP-7-0029" class="indexterm"/></p><p><sup>[<a id="CHP-7-FN-7" href="#ftn.CHP-7-FN-7" class="footnote">81</a>]</sup></p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-1" href="#CHP-7-FN-1" class="para">75</a>] </sup>The vulnerable source code revision 792.13.8 of XNU can be downloaded at <a class="ulink" href="http://www.opensource.apple.com/tarballs/xnu/xnu-792.13.8.tar.gz">http://www.opensource.apple.com/tarballs/xnu/xnu-792.13.8.tar.gz</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-2" href="#CHP-7-FN-2" class="para">76</a>] </sup>See “‘You need to restart your computer’ (kernel panic) message appears (Mac OS X v10.5, 10.6)” at <a class="ulink" href="http://support.apple.com/kb/TS3742">http://support.apple.com/kb/TS3742</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-3" href="#CHP-7-FN-3" class="para">77</a>] </sup>See “Kernel Extension Programming Topics: Debugging a Kernel Extension with GDB” in <span class="emphasis"><em>Mac OS X Developer Library</em></span> at <a class="ulink" href="http://developer.apple.com/library/mac/#documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptDebugger/debug_tutorial.html">http://developer.apple.com/library/mac/#documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptDebugger/debug_tutorial.html</a> and “Kernel Programming Guide: When Things Go Wrong; Debugging the Kernel” in <span class="emphasis"><em>Mac OS X Developer Library</em></span> at <a class="ulink" href="http://developer.apple.com/library/mac/documentation/Darwin/Conceptual/KernelProgramming/build/build.html#//apple_ref/doc/uid/TP30000905-CH221-CIHBJCGC">http://developer.apple.com/library/mac/documentation/Darwin/Conceptual/KernelProgramming/build/build.html#//apple_ref/doc/uid/TP30000905-CH221-CIHBJCGC</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-4" href="#CHP-7-FN-4" class="para">78</a>] </sup>See <a class="ulink" href="http://www.trapkit.de/books/bhd/">http://www.trapkit.de/books/bhd/</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-5" href="#CHP-7-FN-5" class="para">79</a>] </sup>The source code of the fixed XNU version 792.24.17 is available at <a class="ulink" href="http://www.opensource.apple.com/tarballs/xnu/xnu-792.24.17.tar.gz">http://www.opensource.apple.com/tarballs/xnu/xnu-792.24.17.tar.gz</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-6" href="#CHP-7-FN-6" class="para">80</a>] </sup>My security advisory that describes the details of the Mac OS X kernel vulnerability can be found at <a class="ulink" href="http://www.trapkit.de/advisories/TKADV2007-001.txt">http://www.trapkit.de/advisories/TKADV2007-001.txt</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-7" href="#CHP-7-FN-7" class="para">81</a>] </sup>The initial FreeBSD version of <span class="emphasis"><em>tty.c</em></span> from 1994 can be found at <a class="ulink" href="http://www.freebsd.org/cgi/cvsweb.cgi/src/sys/kern/tty.c?rev=1.1;content-type=text/plain">http://www.freebsd.org/cgi/cvsweb.cgi/src/sys/kern/tty.c?rev=1.1;content-type=text/plain</a>.</p></div></div></div></body></html>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>7.5 Addendum</title><link rel="stylesheet" href="core.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.74.0"/></head><body><div class="sect1" title="7.5 Addendum"><div class="titlepage"><div><div><h1 class="title"><a id="addendum-id5"/>7.5 Addendum</h1></div></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>Thursday, November 15, 2007</em></span></p></div><p>Since the vulnerability has been fixed and a new version of the XNU kernel of OS X is available, I released a detailed security advisory on my website today.<sup>[<a href="ch07s05.html#ftn.CHP-7-FN-6" class="footnoteref">80</a>]</sup> The bug was assigned CVE-2007-4686.<a id="IDX-CHP-7-0025" class="indexterm"/></p><p>After I published the advisory, Theo de Raadt (the founder of OpenBSD and OpenSSH) hinted that this bug is older than 4.4BSD and was fixed roughly 15 years ago by everyone but Apple. In the initial revision of FreeBSD from 1994, the implementation of the <code class="literal">TIOCSETD</code> IOCTL looks like this:<sup>[<a href="ch07s05.html#ftn.CHP-7-FN-7" class="footnoteref">81</a>]</sup><a id="IDX-CHP-7-0026" class="indexterm"/><a id="IDX-CHP-7-0027" class="indexterm"/></p><a id="I_programlisting7_d1e8648"/><pre class="programlisting">[..]
804       case TIOCSETD: {        /* set line discipline */
805           register int t = *(int *)data;
806           dev_t device = tp-&gt;t_dev;
807
<strong class="userinput"><code>808           if ((u_int)t &gt;= nlinesw)</code></strong>
<strong class="userinput"><code>809               return (ENXIO);</code></strong>
810           if (t != tp-&gt;t_line) {
811               s = spltty();
812               (*linesw[tp-&gt;t_line].l_close)(tp, flag);
813               error = (*linesw[t].l_open)(device, tp);
814               if (error) {
815                   (void)(*linesw[tp-&gt;t_line].l_open)(device, tp);
816                   splx(s);
817                   return (error);
818               }
819               tp-&gt;t_line = t;
820               splx(s);
821           }
822           break;
823       }
[..]</pre><p>Since <code class="literal">t</code> gets cast into an unsigned int in line 808, it can never become negative. If the user-derived data is greater than <code class="literal">0x80000000</code>, the function returns with an error (see line 809). So Theo was right—the bug was indeed already fixed in 1994. <a class="xref" href="ch07s05.html#timeline_from_the_time_i_notified_apple" title="Figure 7-4. Timeline from the time I notified Apple until I released a security advisory">Figure 7-4</a> shows the timeline of the bug’s fix.</p><div class="figure"><a id="timeline_from_the_time_i_notified_apple"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject7_d1e8669"/><img src="httpatomoreillycomsourcenostarchimages939329.png.jpg" alt="Timeline from the time I notified Apple until I released a security advisory"/></div></div><p class="title">Figure 7-4. Timeline from the time I notified Apple until I released a security advisory</p></div><div class="sect2" title="Notes"><div class="titlepage"><div><div><h2 class="title"><a id="notes-id6"/>Notes</h2></div></div></div><p><sup>[<a id="CHP-7-FN-1" href="#ftn.CHP-7-FN-1" class="footnote">75</a>]</sup><a id="IDX-CHP-7-0028" class="indexterm"/></p><p><sup>[<a id="CHP-7-FN-2" href="#ftn.CHP-7-FN-2" class="footnote">76</a>]</sup></p><p><sup>[<a id="CHP-7-FN-3" href="#ftn.CHP-7-FN-3" class="footnote">77</a>]</sup></p><p><sup>[<a id="CHP-7-FN-4" href="#ftn.CHP-7-FN-4" class="footnote">78</a>]</sup></p><p><sup>[<a id="CHP-7-FN-5" href="#ftn.CHP-7-FN-5" class="footnote">79</a>]</sup></p><p><sup>[<a id="CHP-7-FN-6" href="#ftn.CHP-7-FN-6" class="footnote">80</a>]</sup><a id="IDX-CHP-7-0029" class="indexterm"/></p><p><sup>[<a id="CHP-7-FN-7" href="#ftn.CHP-7-FN-7" class="footnote">81</a>]</sup></p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-1" href="#CHP-7-FN-1" class="para">75</a>] </sup>The vulnerable source code revision 792.13.8 of XNU can be downloaded at <a class="ulink" href="http://www.opensource.apple.com/tarballs/xnu/xnu-792.13.8.tar.gz">http://www.opensource.apple.com/tarballs/xnu/xnu-792.13.8.tar.gz</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-2" href="#CHP-7-FN-2" class="para">76</a>] </sup>See “‘You need to restart your computer’ (kernel panic) message appears (Mac OS X v10.5, 10.6)” at <a class="ulink" href="http://support.apple.com/kb/TS3742">http://support.apple.com/kb/TS3742</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-3" href="#CHP-7-FN-3" class="para">77</a>] </sup>See “Kernel Extension Programming Topics: Debugging a Kernel Extension with GDB” in <span class="emphasis"><em>Mac OS X Developer Library</em></span> at <a class="ulink" href="http://developer.apple.com/library/mac/#documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptDebugger/debug_tutorial.html">http://developer.apple.com/library/mac/#documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptDebugger/debug_tutorial.html</a> and “Kernel Programming Guide: When Things Go Wrong; Debugging the Kernel” in <span class="emphasis"><em>Mac OS X Developer Library</em></span> at <a class="ulink" href="http://developer.apple.com/library/mac/documentation/Darwin/Conceptual/KernelProgramming/build/build.html#//apple_ref/doc/uid/TP30000905-CH221-CIHBJCGC">http://developer.apple.com/library/mac/documentation/Darwin/Conceptual/KernelProgramming/build/build.html#//apple_ref/doc/uid/TP30000905-CH221-CIHBJCGC</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-4" href="#CHP-7-FN-4" class="para">78</a>] </sup>See <a class="ulink" href="http://www.trapkit.de/books/bhd/">http://www.trapkit.de/books/bhd/</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-5" href="#CHP-7-FN-5" class="para">79</a>] </sup>The source code of the fixed XNU version 792.24.17 is available at <a class="ulink" href="http://www.opensource.apple.com/tarballs/xnu/xnu-792.24.17.tar.gz">http://www.opensource.apple.com/tarballs/xnu/xnu-792.24.17.tar.gz</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-6" href="#CHP-7-FN-6" class="para">80</a>] </sup>My security advisory that describes the details of the Mac OS X kernel vulnerability can be found at <a class="ulink" href="http://www.trapkit.de/advisories/TKADV2007-001.txt">http://www.trapkit.de/advisories/TKADV2007-001.txt</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-7-FN-7" href="#CHP-7-FN-7" class="para">81</a>] </sup>The initial FreeBSD version of <span class="emphasis"><em>tty.c</em></span> from 1994 can be found at <a class="ulink" href="http://www.freebsd.org/cgi/cvsweb.cgi/src/sys/kern/tty.c?rev=1.1;content-type=text/plain">http://www.freebsd.org/cgi/cvsweb.cgi/src/sys/kern/tty.c?rev=1.1;content-type=text/plain</a>.</p></div></div></div></body></html>
